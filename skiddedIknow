
-- sky vr

isnetworkowner = function(v)
    local success, result = pcall(function()
        return v.ReceiveAge == 0 and not v.NetworkIsSleeping
    end)
    if success then
        return result
    else
        return v.ReceiveAge
    end
end

local global = getgenv()

local plr = game.Players.LocalPlayer
local input = game:GetService("UserInputService")

local function createpart(size, name,h)
	local Part = Instance.new("Part")
	if h and global.options.outlinesEnabled then 
		local SelectionBox = Instance.new("SelectionBox")
		SelectionBox.Adornee = Part
		SelectionBox.LineThickness = 0.05
		SelectionBox.Parent = Part
	end
	Part.Parent = workspace
	Part.CFrame = plr.Character.HumanoidRootPart.CFrame
	Part.Size = size
	Part.Transparency = 1
	Part.CanCollide = false
	Part.Anchored = true
	Part.Name = name
	return Part
end

local lefthandpart = createpart(Vector3.new(2,1,1), "moveRH",true)
local righthandpart = createpart(Vector3.new(2,1,1), "moveRH",true)
local headpart = createpart(Vector3.new(1,1,1), "moveH",false)
local lefttoypart = createpart(Vector3.new(1,1,1), "LToy",true)
local righttoypart =  createpart(Vector3.new(1,1,1), "RToy",true)
local thirdpersonpart = createpart(Vector3.new(1,1,1), "thirdpersonpart",false)
local thirdperson = false
local lefttoyenable = false
local righttoyenable = false
local lfirst = true
local rfirst = true
local ltoypos = CFrame.new(1.15,0,0) * CFrame.Angles(0,math.rad(180),0)
local rtoypos = CFrame.new(1.15,0,0) * CFrame.Angles(0,math.rad(0),0)

function Align(Part1,Part0,CFrameOffset) 
    local con;con=game:GetService("RunService").PostSimulation:Connect(function()
        if not Part1:IsDescendantOf(workspace) then con:Disconnect() return end
        if not isnetworkowner(Part1) then return end
        Part1.CanCollide=false;
        Part1.CFrame=Part0.CFrame*CFrameOffset;
        Part1.Velocity = Vector3.new(20,20,20) or getgenv().options.NetVelocity;
    end)

    return {}
end


function filterMeshID(id)
    return (string.find(id,'assetdelivery')~=nil and string.match(string.sub(id,37,#id),"%d+")) or string.match(id,"%d+")
end

function findMeshID(id)
    for i,v in pairs(getgenv().headhats) do
        if i=="meshid:"..id then return true,headpart,v end
    end
    if getgenv().right=="meshid:"..id then return  true,righthandpart,CFrame.new() end
    if getgenv().left=="meshid:"..id then return   true,lefthandpart,CFrame.new() end
    if options.leftToy=="meshid:"..id then return  true,lefttoypart,CFrame.new() end
    if options.rightToy=="meshid:"..id then return true,righttoypart,CFrame.new() end
    return false
end

function findHatName(id)
    for i,v in pairs(getgenv().headhats) do
        if i==id then return true,headpart,v end
    end
    if getgenv().right==id then return  true,righthandpart,CFrame.new() end
    if getgenv().left==id then return   true,lefthandpart,CFrame.new() end
    if options.leftToy==id then return  true,lefttoypart,CFrame.new() end
    if options.rightToy==id then return true,righttoypart,CFrame.new() end
    return false
end

local function FEScript(char)

	local foundmeshids = {}
	for i,v in ipairs(char:GetDescendants()) do
		if not v:IsA"Accessory" then continue end
		if not v:FindFirstChild"Handle" then continue end
		local mesh = v.Handle:FindFirstChildOfClass("SpecialMesh")
        if not v.Handle:FindFirstChildOfClass("SpecialMesh") then mesh = v.Handle end
        
        local is,d,cf = findMeshID(filterMeshID(mesh.MeshId))
	    if foundmeshids["meshid:"..filterMeshID(mesh.MeshId)] then is = false else foundmeshids["meshid:"..filterMeshID(mesh.MeshId)] = true end
	
        if is then
            Align(v.Handle,d,cf)
            v.Handle.Transparency = (d.Name=="moveH" and global.options.HeadHatTransparency) or 0
        else
            local is,d,cf = findHatName(v.Name)
	    	if not is then continue end
            Align(v.Handle,d,cf)
            v.Handle.Transparency = (d.Name=="moveH" and global.options.HeadHatTransparency) or 0
        end
	end
end


do
	for i,v in ipairs(plr.Character.HumanoidRootPart:GetChildren()) do
		if v:IsA("Sound") then
			v.Volume = 0
		end
	end
	if plr.Character:FindFirstChild("Head") then
		plr.Character.Head:Destroy()
	end
	plr.Character.Humanoid.Health = 0
	game:GetService("RunService").PostSimulation:connect(function()
		for i,v in ipairs(game:GetService("Players").LocalPlayer.Character:GetDescendants()) do
			if v:IsA("BasePart") and v.Name ~="HumanoidRootPart" then 
					v.Velocity = global.options.NetVelocity
			end
		end
	end)
	FEScript(plr.Character)
	plr.CharacterAdded:Connect(function(char)

		local hrp = char:WaitForChild("HumanoidRootPart")
		local head = char:WaitForChild("Head")
		local hum = char:FindFirstChildOfClass("Humanoid")
		local continueTping = global.options.vccompatibility
		coroutine.wrap(function()
			while continueTping do
				task.wait()
				hrp.CFrame = headpart.CFrame
			end
		end)()

		
		task.wait(0.25)	
		continueTping = false
		for i,v in ipairs(hrp:GetChildren()) do
			if v:IsA("Sound") then
				v.Volume = 0
			end
		end
		char.Humanoid.Health = 0

		FEScript(char)
	end)
end

-- vr handler starts here
coroutine.wrap(function()
	local cam = workspace.CurrentCamera
	cam:GetPropertyChangedSignal("CFrame"):Connect(function()
		cam.CameraType = "Scriptable"
		cam.HeadScale = global.options.headscale
	end)
end)()
local cam = workspace.CurrentCamera

cam.CameraType = "Scriptable"
cam.HeadScale = global.options.headscale

local Cfrzero = CFrame.new(1,0,0)

game:GetService("StarterGui"):SetCore("VREnableControllerModels", false)

input.UserCFrameChanged:connect(function(part,move)
	cam.CameraType = "Scriptable"
	cam.HeadScale = global.options.headscale
    pcall(function()
    	if part == Enum.UserCFrame.Head then
    		headpart.CFrame = Cfrzero
			thirdpersonpart.CFrame = Cfrzero
    	elseif part == Enum.UserCFrame.LeftHand then
    		lefthandpart.CFrame = Cfrzero
    	    if lefttoyenable then
                lefttoypart.CFrame = Cfrzero
            end
        elseif part == Enum.UserCFrame.RightHand then
    		righthandpart.CFrame = Cfrzero
    	    if righttoyenable then
                righttoypart.CFrame = Cfrzero
            end
		end
    end)	
end)

input.InputBegan:connect(function(key)
	if key.KeyCode == global.options.thirdPersonButtonToggle then
		thirdperson = not thirdperson -- disabled?
	end
	if key.KeyCode == Enum.KeyCode.ButtonR1 then
		R1down = true
	end
    if key.KeyCode == global.options.leftToyBind then
		if not lfirst then
			ltoypos = lefttoypart.CFrame:ToObjectSpace(lefthandpart.CFrame):Inverse()
		end
		lfirst = false
        lefttoyenable = not lefttoyenable
    end
	if key.KeyCode == global.options.rightToyBind then
		if not rfirst then
			rtoypos = righttoypart.CFrame:ToObjectSpace(righthandpart.CFrame):Inverse()
		end
		rfirst = false
        righttoyenable = not righttoyenable
    end
end)

input.InputEnded:connect(function(key)
	if key.KeyCode == Enum.KeyCode.ButtonR1 then
		R1down = false
	end
end)

game:GetService("RunService").RenderStepped:connect(function()
	if R1down then
		cam.CFrame = cam.CFrame:Lerp(cam.CoordinateFrame + (righthandpart.CFrame * CFrame.Angles(math.rad(global.options.controllerRotationOffset.X-global.options.righthandrotoffset.X),math.rad(global.options.controllerRotationOffset.Y-global.options.righthandrotoffset.Y),math.rad(global.options.controllerRotationOffset.Z-global.options.righthandrotoffset.Z))).LookVector * cam.HeadScale/2, 0.5)
	end
end)
